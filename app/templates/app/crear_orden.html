{% extends 'app/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block contenido %}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-7 col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header card-header-branding">
                    <h2 class="mb-0">Crear Orden de Compra</h2>
                </div>
                <div class="card-body">

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-danger" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if form.errors or detalle_formset.errors %}
                         <div class="alert alert-danger">
                             Por favor corrige los errores indicados abajo.
                             {{ detalle_formset.non_form_errors }}
                         </div>
                    {% endif %}

                    <form id="orden-form" method="post">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ orden_form.cliente.id_for_label }}" class="form-label">{{ orden_form.cliente.label }}</label>
                                {{ orden_form.cliente }}
                                {% if orden_form.cliente.errors %} <div class="invalid-feedback d-block">{{ orden_form.cliente.errors }}</div> {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ orden_form.rut.id_for_label }}" class="form-label">{{ orden_form.rut.label }}</label>
                                {{ orden_form.rut }}
                                {% if orden_form.rut.errors %} <div class="invalid-feedback d-block">{{ orden_form.rut.errors }}</div> {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="{{ orden_form.direccion.id_for_label }}" class="form-label">{{ orden_form.direccion.label }}</label>
                                {{ orden_form.direccion }}
                                {% if orden_form.direccion.errors %} <div class="invalid-feedback d-block">{{ orden_form.direccion.errors }}</div> {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">
                        <h4 class="mb-3">Detalle de Productos</h4>
                        {{ detalle_formset.management_form }}

                        <div id="detalle-formset-container">
                            {% for form in detalle_formset %}
                                <div class="detalle-form border-bottom pb-3 mb-3" id="{{ form.prefix }}-row"> {% if form.instance.pk %}{{ form.id }}{% endif %}
                                    <div class="row align-items-center"> 
                                        <div class="col-md-5 mb-3">
                                            <label for="{{ form.producto.id_for_label }}" class="form-label">{{ form.producto.label }}</label>
                                            {{ form.producto }}
                                            {% if form.producto.errors %} <div class="invalid-feedback d-block">{{ form.producto.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label for="{{ form.cantidad.id_for_label }}" class="form-label">{{ form.cantidad.label }}</label>
                                            <span class="text-muted small d-block stock-display" id="stock-{{ form.prefix }}"></span>
                                            {{ form.cantidad }}
                                            {% if form.cantidad.errors %} <div class="invalid-feedback d-block">{{ form.cantidad.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ form.precio_unitario.id_for_label }}" class="form-label">{{ form.precio_unitario.label }}</label>
                                            {{ form.precio_unitario }}
                                            {% if form.precio_unitario.errors %} <div class="invalid-feedback d-block">{{ form.precio_unitario.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-2 mb-3 align-self-end"> {% if form.can_delete or detalle_formset.can_delete_extra %}
                                                {{ form.DELETE }}
                                                <button type="button" class="btn btn-danger btn-sm remove-form-row w-100"> <i class="fas fa-trash"></i> Quitar
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if form.non_field_errors %}
                                        <div class="alert alert-danger mt-2">
                                            {{ form.non_field_errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <div id="empty-form-template" style="display: none;">
                            <div class="detalle-form border-bottom pb-3 mb-3" id="{{ detalle_formset.empty_form.prefix }}-row">
                                <div class="row align-items-center">
                                    <div class="col-md-5 mb-3">
                                        <label for="{{ detalle_formset.empty_form.producto.id_for_label }}" class="form-label">{{ detalle_formset.empty_form.producto.label }}</label>
                                        {{ detalle_formset.empty_form.producto }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ detalle_formset.empty_form.cantidad.id_for_label }}" class="form-label">{{ detalle_formset.empty_form.cantidad.label }}</label>
                                        <span class="text-muted small d-block stock-display" id="stock-{{ detalle_formset.empty_form.prefix }}"></span>
                                        {{ detalle_formset.empty_form.cantidad }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ detalle_formset.empty_form.precio_unitario.id_for_label }}" class="form-label">{{ detalle_formset.empty_form.precio_unitario.label }}</label>
                                        {{ detalle_formset.empty_form.precio_unitario }}
                                    </div>
                                    <div class="col-md-2 mb-3 align-self-end">
                                        {{ detalle_formset.empty_form.DELETE }}
                                        <button type="button" class="btn btn-danger btn-sm remove-form-row w-100">
                                            <i class="fas fa-trash"></i> Quitar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" id="add-form-row" class="btn btn-success mt-2">
                            <i class="fas fa-plus"></i> Añadir Producto
                        </button>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-principal btn-lg">Guardar Orden</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5 col-md-12">
             <h5 class="text-center fw-bold mb-3" style="color: #BF2642;">Vista Previa de Comprobante</h5>
             <div id="preview-ticket" class="card shadow-sm p-4 mx-auto" style="max-width: 400px; min-height: 500px; font-family: 'Courier New', monospace;">
                 </div>
        </div>
    </div>
</div>

{% endblock contenido %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('detalle-formset-container');
    const addButton = document.getElementById('add-form-row');
    const template = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS');
    const form = document.getElementById('orden-form');

    // --- NUEVA FUNCIÓN PARA OBTENER STOCK ---
    async function fetchStock(productoId, stockDisplayElement) {
        if (!productoId) {
            stockDisplayElement.textContent = '';
            return;
        }
        try {
            const response = await fetch(`/api/get_stock_producto/${productoId}/`);
            if (!response.ok) {
                throw new Error('Error al obtener stock');
            }
            const data = await response.json();
            stockDisplayElement.textContent = `Stock: ${data.stock}`;
            stockDisplayElement.style.color = data.stock > 0 ? 'green' : 'red';
        } catch (error) {
            console.error(error);
            stockDisplayElement.textContent = 'Stock: N/A';
            stockDisplayElement.style.color = 'gray';
        }
    }

    // --- NUEVA FUNCIÓN PARA ESCUCHAR CAMBIOS DE PRODUCTO ---
    function addStockListener(row) {
        const productoSelect = row.querySelector('.producto-select');
        const stockDisplay = row.querySelector('.stock-display');
        if (productoSelect && stockDisplay) {
            productoSelect.addEventListener('change', (e) => {
                fetchStock(e.target.value, stockDisplay);
            });
            // Cargar stock al inicio para formularios existentes
            if(productoSelect.value) {
                fetchStock(productoSelect.value, stockDisplay);
            }
        }
    }
    
    // --- LÓGICA DE FORMSET (MODIFICADA) ---
    addButton.addEventListener('click', function() {
        let currentFormCount = parseInt(totalFormsInput.value, 10);
        let newFormHtml = template.replace(/__prefix__/g, currentFormCount);
        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        let newFormNode = tempDiv.firstElementChild; 

        formsetContainer.appendChild(newFormNode);
        totalFormsInput.value = currentFormCount + 1;

        updateRemoveButtonListeners();
        attachFormListener();
        addStockListener(newFormNode); // <-- AÑADIDO: Escuchar stock en la nueva fila
    });

    // ... (función removeRow sin cambios) ...
    function updateRemoveButtonListeners() {
        formsetContainer.querySelectorAll('.remove-form-row').forEach(button => {
            button.removeEventListener('click', removeRow);
            button.addEventListener('click', removeRow);
        });
    }

    function removeRow(e) {
        let row = e.target.closest('.detalle-form');
        let deleteInput = row.querySelector('input[id$="-DELETE"]');
        if (deleteInput) {
            let idInput = row.querySelector('input[type="hidden"][name$="-id"]');
            if (idInput && idInput.value) {
                 deleteInput.checked = true;
                 row.style.display = 'none';
            } else {
                 row.remove();
            }
        } else {
             row.remove();
        }
        updatePreview();
    }
    
    // --- LÓGICA DE VISTA PREVIA (SIN CAMBIOS) ---
    const previewCliente = document.getElementById('preview-cliente');
    // ... (resto de variables de vista previa) ...
    const previewTotal = document.getElementById('preview-total');
    const formatCurrency = (number) => '$' + new Intl.NumberFormat('es-CL').format(Math.round(number || 0));

    function updatePreview() {
        // ... (código de updatePreview idéntico) ...
        previewCliente.textContent = document.getElementById('id_cliente').value || 'N/A';
        previewRut.textContent = document.getElementById('id_rut').value || 'N/A';
        previewDireccion.textContent = document.getElementById('id_direccion').value || 'N/A';
        // ... (resto del código) ...
        previewTotal.textContent = formatCurrency(granTotal);
    }
    
    // --- LÓGICA DE ESCUCHA DE EVENTOS (MODIFICADA) ---
    function attachFormListener() {
        form.removeEventListener('input', updatePreview); 
        form.addEventListener('input', updatePreview);
        
        // Añadir listeners de stock a las filas existentes
        document.querySelectorAll('.detalle-form').forEach(row => {
            addStockListener(row);
        });
    }

    updateRemoveButtonListeners();
    attachFormListener();
    updatePreview();
});
</script>
{% endblock extra_js %}