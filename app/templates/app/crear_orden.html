{% extends 'app/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block contenido %}

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-lg-7 col-md-12 mb-4">
            <div class="card shadow-sm">
                <div class="card-header card-header-branding">
                    <h2 class="mb-0">Crear Orden de Compra</h2>
                </div>
                <div class="card-body">

                    {% if messages %}
                        {% for message in messages %}
                            <div class="alert alert-danger" role="alert">
                                {{ message }}
                            </div>
                        {% endfor %}
                    {% endif %}
                    {% if form.errors or detalle_formset.errors %}
                         <div class="alert alert-danger">
                             Por favor corrige los errores indicados abajo.
                             {{ detalle_formset.non_form_errors }}
                         </div>
                    {% endif %}

                    <form id="orden-form" method="post">
                        {% csrf_token %}

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ orden_form.cliente.id_for_label }}" class="form-label">{{ orden_form.cliente.label }}</label>
                                {{ orden_form.cliente }}
                                {% if orden_form.cliente.errors %} <div class="invalid-feedback d-block">{{ orden_form.cliente.errors }}</div> {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ orden_form.rut.id_for_label }}" class="form-label">{{ orden_form.rut.label }}</label>
                                {{ orden_form.rut }}
                                {% if orden_form.rut.errors %} <div class="invalid-feedback d-block">{{ orden_form.rut.errors }}</div> {% endif %}
                            </div>
                            <div class="col-md-12 mb-3">
                                <label for="{{ orden_form.direccion.id_for_label }}" class="form-label">{{ orden_form.direccion.label }}</label>
                                {{ orden_form.direccion }}
                                {% if orden_form.direccion.errors %} <div class="invalid-feedback d-block">{{ orden_form.direccion.errors }}</div> {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <h4 class="mb-3">Detalle de Productos</h4>

                        {{ detalle_formset.management_form }}

                        <div id="detalle-formset-container">
                            {% for form in detalle_formset %}
                                <div class="detalle-form border-bottom pb-3 mb-3" id="{{ form.prefix }}-row"> {% if form.instance.pk %}{{ form.id }}{% endif %}
                                    <div class="row align-items-center"> <div class="col-md-5 mb-3">
                                            <label for="{{ form.producto.id_for_label }}" class="form-label">{{ form.producto.label }}</label>
                                            {{ form.producto }}
                                            {% if form.producto.errors %} <div class="invalid-feedback d-block">{{ form.producto.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-2 mb-3">
                                            <label for="{{ form.cantidad.id_for_label }}" class="form-label">{{ form.cantidad.label }}</label>
                                            {{ form.cantidad }}
                                            {% if form.cantidad.errors %} <div class="invalid-feedback d-block">{{ form.cantidad.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label for="{{ form.precio_unitario.id_for_label }}" class="form-label">{{ form.precio_unitario.label }}</label>
                                            {{ form.precio_unitario }}
                                            {% if form.precio_unitario.errors %} <div class="invalid-feedback d-block">{{ form.precio_unitario.errors }}</div> {% endif %}
                                        </div>
                                        <div class="col-md-2 mb-3 align-self-end"> {% if form.can_delete or detalle_formset.can_delete_extra %}
                                                {{ form.DELETE }}
                                                <button type="button" class="btn btn-danger btn-sm remove-form-row w-100"> <i class="fas fa-trash"></i> Quitar
                                                </button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% if form.non_field_errors %}
                                        <div class="alert alert-danger mt-2">
                                            {{ form.non_field_errors }}
                                        </div>
                                    {% endif %}
                                </div>
                            {% endfor %}
                        </div>

                        <div id="empty-form-template" style="display: none;">
                            <div class="detalle-form border-bottom pb-3 mb-3" id="{{ detalle_formset.empty_form.prefix }}-row">
                                <div class="row align-items-center">
                                    <div class="col-md-5 mb-3">
                                        <label for="{{ detalle_formset.empty_form.producto.id_for_label }}" class="form-label">{{ detalle_formset.empty_form.producto.label }}</label>
                                        {{ detalle_formset.empty_form.producto }}
                                    </div>
                                    <div class="col-md-2 mb-3">
                                        <label for="{{ detalle_formset.empty_form.cantidad.id_for_label }}" class="form-label">{{ detalle_formset.empty_form.cantidad.label }}</label>
                                        {{ detalle_formset.empty_form.cantidad }}
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label for="{{ detalle_formset.empty_form.precio_unitario.id_for_label }}" class="form-label">{{ detalle_formset.empty_form.precio_unitario.label }}</label>
                                        {{ detalle_formset.empty_form.precio_unitario }}
                                    </div>
                                    <div class="col-md-2 mb-3 align-self-end">
                                        {{ detalle_formset.empty_form.DELETE }}
                                        <button type="button" class="btn btn-danger btn-sm remove-form-row w-100">
                                            <i class="fas fa-trash"></i> Quitar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <button type="button" id="add-form-row" class="btn btn-success mt-2">
                            <i class="fas fa-plus"></i> Añadir Producto
                        </button>

                        <div class="d-grid gap-2 mt-4">
                            <button type="submit" class="btn btn-principal btn-lg">Guardar Orden</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-5 col-md-12">
             <h5 class="text-center fw-bold mb-3" style="color: #BF2642;">Vista Previa de Comprobante</h5>
             <div id="preview-ticket" class="card shadow-sm p-4 mx-auto" style="max-width: 400px; min-height: 500px; font-family: 'Courier New', monospace;">
                 <div class="logo-container d-flex justify-content-between align-items-center mb-3">
                     <div class="logo">
                         <img src="{% static 'app/img/logo.png' %}" alt="Logo" class="logo-img" style="width: auto; height: 50px;">
                     </div>
                     <div class="empresa text-start small">
                         <strong>CONSTRUCCIONES V & G LIZ CASTILLO GARCIA SPA</strong><br>
                         RUT: 77.858.577-4<br>
                         Dirección: Vilaco 301, Toconao<br>
                         Teléfono: +56 9 1234 5678
                     </div>
                 </div>
                 <hr class="my-2">
                 <div class="orden-info text-start small mb-3">
                     <strong>Orden de Compra #<span id="preview-id">Generando...</span></strong><br>
                     Cliente: <span id="preview-cliente">N/A</span><br>
                     Rut: <span id="preview-rut">N/A</span><br>
                     Fecha: <span id="preview-fecha">{% now "d-m-Y H:i" %}</span><br>
                     Dirección: <span id="preview-direccion">N/A</span>
                 </div>
                 <hr class="my-2">
                 <strong class="text-start d-block mb-1">Detalle</strong>
                 <table class="productos table table-sm small">
                     <thead>
                         <tr>
                             <th class="text-start">Producto</th>
                             <th style="width: 15%;">Cant</th>
                             <th style="width: 25%;">P. Unit.</th>
                             <th style="width: 25%;" class="text-end">Total</th>
                         </tr>
                     </thead>
                     <tbody id="preview-productos-lista">
                         <tr id="preview-empty-row"><td colspan="4" class="text-center text-muted">...</td></tr>
                     </tbody>
                 </table>
                 <hr class="my-2">
                 <div class="total text-end fw-bold">
                     <small>Total a Pagar:</small> <span class="fs-6" id="preview-total">$0</span>
                 </div>
                 <hr class="my-2">
                 <div class="gracias small mt-3 text-center">¡Gracias por su compra!<br>Esperamos atenderle pronto.</div>
             </div>
        </div>
    </div>
</div>

{% endblock contenido %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const formsetContainer = document.getElementById('detalle-formset-container');
    const addButton = document.getElementById('add-form-row');
    const template = document.getElementById('empty-form-template').innerHTML;
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS'); // Asegúrate que el prefix sea 'detalles'
    const form = document.getElementById('orden-form');

    addButton.addEventListener('click', function() {
        let currentFormCount = parseInt(totalFormsInput.value, 10);
        let newFormHtml = template.replace(/__prefix__/g, currentFormCount);
        // Convertimos el string HTML a un nodo del DOM
        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        let newFormNode = tempDiv.firstElementChild; // Obtenemos el div .detalle-form

        formsetContainer.appendChild(newFormNode);
        totalFormsInput.value = currentFormCount + 1;

        updateRemoveButtonListeners();
        attachFormListener(); // Re-attach listener para incluir la nueva fila
    });

    function updateRemoveButtonListeners() {
        formsetContainer.querySelectorAll('.remove-form-row').forEach(button => {
            button.removeEventListener('click', removeRow);
            button.addEventListener('click', removeRow);
        });
    }

    function removeRow(e) {
        let row = e.target.closest('.detalle-form');
        let deleteInput = row.querySelector('input[id$="-DELETE"]');
        if (deleteInput) { // Si existe el input DELETE (es una fila ya existente o una nueva que podría guardarse)
            // Primero, buscamos el input id (ej: id_detalles-0-id)
            let idInput = row.querySelector('input[type="hidden"][name$="-id"]');
            if (idInput && idInput.value) { // Si tiene un ID, es una fila guardada
                 deleteInput.checked = true;
                 row.style.display = 'none'; // Ocultamos la fila guardada
            } else { // Si no tiene ID, es una fila nueva, la eliminamos del DOM
                 row.remove();
                 // Decrementar TOTAL_FORMS solo si eliminamos una fila nueva del DOM
                 // totalFormsInput.value = parseInt(totalFormsInput.value) - 1; // Django maneja esto bien generalmente
            }
        } else { // Si no hay input DELETE (debería haberlo por empty_form), la eliminamos
             row.remove();
             // totalFormsInput.value = parseInt(totalFormsInput.value) - 1; // Django maneja esto bien generalmente
        }
        updatePreview();
    }


    const previewCliente = document.getElementById('preview-cliente');
    const previewRut = document.getElementById('preview-rut');
    const previewDireccion = document.getElementById('preview-direccion');
    const previewProductosLista = document.getElementById('preview-productos-lista');
    const previewTotal = document.getElementById('preview-total');
    const previewEmptyRow = document.getElementById('preview-empty-row');
    const previewIdSpan = document.getElementById('preview-id');

    const formatCurrency = (number) => '$' + new Intl.NumberFormat('es-CL').format(Math.round(number || 0)); // Añadir fallback para NaN

    function updatePreview() {
        previewCliente.textContent = document.getElementById('id_cliente').value || 'N/A';
        previewRut.textContent = document.getElementById('id_rut').value || 'N/A';
        previewDireccion.textContent = document.getElementById('id_direccion').value || 'N/A';
        previewIdSpan.textContent = 'Generando...';

        previewProductosLista.innerHTML = '';
        let granTotal = 0;
        let hasProducts = false;

        document.querySelectorAll('.detalle-form').forEach(formRow => {
            // Solo procesar filas visibles (no marcadas para eliminar visualmente)
            if (formRow.style.display === 'none') return;

            // También chequear el input DELETE por si acaso
            const isDeleted = formRow.querySelector('input[id$="-DELETE"]')?.checked;
             if (isDeleted) return;

            const productoSelect = formRow.querySelector('.producto-select');
            const cantidadInput = formRow.querySelector('.cantidad-input');
            const precioInput = formRow.querySelector('.precio-input');

            // Asegurarnos que todos los elementos existen antes de procesar
            if (!productoSelect || !cantidadInput || !precioInput) return;

            const productoText = productoSelect.options[productoSelect.selectedIndex]?.text || 'N/A';
            // Validar que no sea el placeholder "---------"
            const productoValue = productoSelect.value;
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const totalLinea = cantidad * precio;

            // Añadir fila solo si se seleccionó un producto y la cantidad es mayor a 0
            if (productoValue && cantidad > 0) {
                hasProducts = true;
                granTotal += totalLinea;
                let newRow = `<tr><td class="text-start">${productoText}</td><td>${cantidad}</td><td>${formatCurrency(precio)}</td><td class="text-end fw-bold">${formatCurrency(totalLinea)}</td></tr>`;
                previewProductosLista.insertAdjacentHTML('beforeend', newRow);
            }
        });

        if (!hasProducts && previewEmptyRow) {
             // Clona el nodo de fila vacía para evitar mover el original
             let emptyRowClone = previewEmptyRow.cloneNode(true);
             previewProductosLista.appendChild(emptyRowClone);
        } else if (hasProducts && previewEmptyRow && previewEmptyRow.parentNode === previewProductosLista) {
             // Si hay productos y la fila vacía aún está, la quitamos
             previewProductosLista.removeChild(previewEmptyRow);
        }


        previewTotal.textContent = formatCurrency(granTotal);
    }

    // Usamos 'input' para captura inmediata, pero 'change' para selects funciona mejor a veces
    function attachFormListener() {
        form.removeEventListener('input', updatePreview); // Limpiar listener viejo
        form.addEventListener('input', updatePreview);
    }

    // Llamadas iniciales
    updateRemoveButtonListeners();
    attachFormListener();
    updatePreview();
});
</script>
{% endblock extra_js %}