{# ventas/templates/ventas/crear_orden.html #}
{% extends 'core/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load humanize %} {# Añadido para formatear números #}

{% block contenido %}

<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-lg-7 col-md-12 mb-4">
      <div class="card shadow-sm">
        <div class="card-header card-header-branding">
          <h2 class="mb-0">Crear Orden de Compra</h2>
        </div>
        <div class="card-body">
          
          {% if messages %}
            {% for message in messages %}
              <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
           {% endif %}

          <form id="orden-form" method="post">
            {% csrf_token %}
            
            <div class="row">
              <div class="col-md-6 mb-3">
                 {{ orden_form.cliente|as_crispy_field }}
              </div>
              <div class="col-md-6 mb-3">
                 {{ orden_form.rut|as_crispy_field }}
              </div>
              <div class="col-md-12 mb-3">
                 {{ orden_form.direccion|as_crispy_field }}
              </div>
            </div>

            <hr class="my-4" />
            <h4 class="mb-3">Detalle de Productos</h4>
            
            {{ detalle_formset.management_form }}

            <div id="detalle-formset-container">
              {% for form in detalle_formset %}
              <div class="detalle-form border-bottom pb-3 mb-3" id="{{ form.prefix }}-row">
                {% if form.instance.pk %}{{ form.id }}{% endif %}
                <div class="row align-items-center">
                  <div class="col-md-5 mb-2">
                      {{ form.producto|as_crispy_field }}
                      <small class="text-muted stock-display" id="stock-{{ form.prefix }}"></small>
                  </div>
                  <div class="col-md-2 mb-2">
                      {{ form.cantidad|as_crispy_field }}
                  </div>
                  <div class="col-md-3 mb-2">
                     {{ form.precio_unitario|as_crispy_field }}
                  </div>
                  <div class="col-md-2 mb-2 d-flex align-items-end">
                      {% if detalle_formset.can_delete %}
                       <div class="form-check" style="display: none;">
                           {{ form.DELETE }}
                       </div>
                       <button type...
                       </button>
                      {% endif %}
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            
            <div id="empty-form-template" style="display: none;">
              <div class="detalle-form border-bottom pb-3 mb-3" id="__prefix__-row">
                 {{ detalle_formset.empty_form.id }}
                <div class="row align-items-center">
                  <div class="col-md-5 mb-2">
                     {{ detalle_formset.empty_form.producto|as_crispy_field }}
                     <small class="text-muted stock-display" id="stock-__prefix__"></small>
                  </div>
                  </div>
              </div>
            </div>

            <button type="button" id="add-form-row" class="btn btn-success mt-2">
              <i class="fas fa-plus"></i> Añadir Producto
            </button>
            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-principal btn-lg">
                Guardar Orden
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <div class="col-lg-5 col-md-12">
        <h5 class="text-center fw-bold mb-3" style="color: #BF2642;">Vista Previa de Comprobante</h5>
        <div id="preview-ticket" class="card shadow-sm p-4 mx-auto" style="max-width: 400px; min-height: 500px; ...">
            <div><strong>Cliente:</strong> <span id="preview-cliente">N/A</span></div>
            <div><strong>RUT:</strong> <span id="preview-rut">N/A</span></div>
            <div><strong>Dirección:</strong> <span id="preview-direccion">N/A</span></div>
            <hr style="border-top: 1px dashed #555;">
            <tbody id="preview-productos-body">
                <tr><td colspan="4" class="text-center text-muted">(Vacío)</td></tr>
            </tbody>
            </table>
            <hr style="border-top: 1px dashed #555;">
            <div class="text-end fw-bold fs-5">Total: <span id="preview-total">$0</span></div>
            </div>
    </div>

  </div>
</div>

{% endblock contenido %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Variables Globales del Formset ---
    const formsetContainer = document.getElementById('detalle-formset-container');
    const addButton = document.getElementById('add-form-row');
    const template = document.getElementById('empty-form-template').innerHTML;
    // Input que le dice a Django cuántos formularios hay
    const totalFormsInput = document.getElementById('id_detalles-TOTAL_FORMS');
    const form = document.getElementById('orden-form'); // El formulario principal

    // --- 1. FUNCIÓN PARA OBTENER STOCK (vía API) ---
    /**
     * Busca el stock de un producto usando la API y actualiza el
     * elemento 'stockDisplayElement' con el resultado.
     * @param {string} productoId - El ID del producto a consultar.
     * @param {HTMLElement} stockDisplayElement - El <small> tag donde mostrar el stock.
     */
    async function fetchStock(productoId, stockDisplayElement) {
        if (!productoId) {
            stockDisplayElement.textContent = "";
            return;
        }
        try {
            // Se usa el tag 'url' de Django para obtener la URL base de la API.
            // Reemplazamos '0' (un placeholder) por el ID del producto real.
            const urlTemplate = "{% url 'inventario:api_get_stock' 0 %}";
            const url = urlTemplate.replace('0', productoId);
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Error ${response.status}`);
            
            const data = await response.json();
            if (data.error) throw new Error(data.error);

            // Actualizar el DOM
            stockDisplayElement.textContent = `Stock: ${data.stock}`;
            stockDisplayElement.style.color = data.stock > 0 ? "green" : "red";

        } catch (error) {
            console.error("Error fetching stock:", error);
            stockDisplayElement.textContent = "Stock: Error";
            stockDisplayElement.style.color = "orange";
        }
    }

    // --- 2. FUNCIÓN PARA AÑADIR LISTENER DE STOCK ---
    /**
     * Añade un event listener 'change' a un <select> de producto
     * para que llame a fetchStock cada vez que el usuario cambia
     * el producto seleccionado.
     * @param {HTMLElement} row - El div (fila) que contiene el formulario.
     */
    function addStockListener(row) {
        // (Asegúrate que los <select> tengan la clase 'producto-select')
        const productoSelect = row.querySelector('.producto-select'); 
        const stockDisplay = row.querySelector('.stock-display');
        
        if (productoSelect && stockDisplay) {
            productoSelect.addEventListener('change', (e) => {
                fetchStock(e.target.value, stockDisplay);
            });
            // Cargar stock al inicio para formularios existentes
            if (productoSelect.value) {
                fetchStock(productoSelect.value, stockDisplay);
            }
        }
    }

    // --- 3. LÓGICA DE FORMSET (Añadir fila) ---
    addButton.addEventListener('click', function() {
        // Obtener el número actual de formularios
        let currentFormCount = parseInt(totalFormsInput.value, 10);
        
        // Reemplazar '__prefix__' en la plantilla por el nuevo índice
        let newFormHtml = template.replace(/__prefix__/g, currentFormCount);
        
        // Crear el nuevo nodo HTML y añadirlo al contenedor
        let tempDiv = document.createElement('div');
        tempDiv.innerHTML = newFormHtml;
        let newFormNode = tempDiv.firstElementChild;
        formsetContainer.appendChild(newFormNode);
        
        // Incrementar el contador TOTAL_FORMS
        totalFormsInput.value = currentFormCount + 1;

        // Añadir listeners al nuevo formulario (stock y eliminar)
        updateRemoveButtonListeners();
        addStockListener(newFormNode);
        updatePreview(); // Actualizar vista previa
    });

    // --- 4. LÓGICA DE FORMSET (Eliminar fila) ---
    /**
     * Función que maneja el clic en un botón 'remove-form-row'.
     * Si la fila es nueva (sin ID), la elimina del DOM.
     * Si la fila ya existía (con ID), marca el checkbox 'DELETE'
     * y la oculta, para que Django la borre en el backend.
     */
    function removeRow(e) {
        let row = e.target.closest('.detalle-form');
        let deleteInput = row.querySelector('input[name$="-DELETE"]'); // Input oculto 'DELETE'
        let idInput = row.querySelector('input[type="hidden"][name$="-id"]'); // Input oculto 'id'

        if (deleteInput) {
            // Si la fila ya existe en la BD (tiene un ID)
            if (idInput && idInput.value) {
                deleteInput.checked = true; // Marcar para borrar
                row.style.display = 'none'; // Ocultar
            } else {
                // Si es una fila nueva (añadida con JS), simplemente borrarla
                row.remove();
            }
        }
        updatePreview(); // Actualizar la vista previa
    }

    /**
     * Actualiza los event listeners de todos los botones 'remove-form-row'.
     * Se llama al inicio y cada vez que se añade una fila.
     */
    function updateRemoveButtonListeners() {
        formsetContainer.querySelectorAll('.remove-form-row').forEach(button => {
            button.removeEventListener('click', removeRow); // Limpiar listener anterior
            button.addEventListener('click', removeRow); // Añadir listener actual
        });
    }

    // --- 5. LÓGICA DE VISTA PREVIA ---
    const previewCliente = document.getElementById('preview-cliente');
    const previewRut = document.getElementById('preview-rut');
    const previewDireccion = document.getElementById('preview-direccion');
    const previewProductosBody = document.getElementById('preview-productos-body');
    const previewTotal = document.getElementById('preview-total');

    // Función auxiliar para formatear a CLP
    const formatCurrency = (number) => '$' + new Intl.NumberFormat('es-CL').format(Math.round(number || 0));

    /**
     * Lee todos los campos del formulario y actualiza el ticket
     * de vista previa en tiempo real.
     */
    function updatePreview() {
        // Actualizar datos del cliente
        previewCliente.textContent = document.getElementById('id_cliente')?.value || 'N/A';
        previewRut.textContent = document.getElementById('id_rut')?.value || 'N/A';
        previewDireccion.textContent = document.getElementById('id_direccion')?.value || 'N/A';

        // Actualizar productos y total
        let granTotal = 0;
        previewProductosBody.innerHTML = ''; // Limpiar tabla
        let hasProducts = false;

        // Iterar sobre cada fila de formulario visible
        formsetContainer.querySelectorAll('.detalle-form').forEach(row => {
            const deleteInput = row.querySelector('input[name$="-DELETE"]');
            // Ignorar filas ocultas o marcadas para borrar
            if (row.style.display === 'none' || (deleteInput && deleteInput.checked)) {
                return;
            }

            // (Asegúrate que los inputs tengan estas clases)
            const productoSelect = row.querySelector('.producto-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            const precioInput = row.querySelector('.precio-input');

            if (productoSelect && cantidadInput && precioInput) {
                const productoNombre = productoSelect.options[productoSelect.selectedIndex]?.text || '...';
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const precio = parseFloat(precioInput.value) || 0;

                if (cantidad > 0 && precio >= 0) {
                    hasProducts = true;
                    const totalLinea = cantidad * precio;
                    granTotal += totalLinea;

                    // Crear la fila <tr> para la vista previa
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td style="text-align: left;">${productoNombre}</td>
                        <td style="text-align: center;">${cantidad}</td>
                        <td style="text-align: right;">${formatCurrency(precio)}</td>
                        <td style="text-align: right;">${formatCurrency(totalLinea)}</td>
                    `;
                    previewProductosBody.appendChild(tr);
                }
            }
        });

        if (!hasProducts) {
            previewProductosBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">(Vacío)</td></tr>';
        }

        // Actualizar el gran total
        previewTotal.textContent = formatCurrency(granTotal);
    }

    // --- 6. INICIALIZACIÓN ---
    
    // Escuchar cualquier cambio en el formulario para actualizar la vista previa
    form.addEventListener('input', updatePreview);
    
    // Añadir listeners de stock a las filas que cargaron inicialmente
    document.querySelectorAll('.detalle-form').forEach(row => {
        addStockListener(row);
    });

    // Inicializar listeners de botones 'eliminar'
    updateRemoveButtonListeners();
    // Cargar la vista previa inicial
    updatePreview();
});
</script>
{% endblock extra_js %}